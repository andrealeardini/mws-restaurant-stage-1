"use strict";!function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function t(t,n,r){var o,i=new Promise(function(i,a){e(o=t[n].apply(t,r)).then(i,a)});return i.request=o,i}function n(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function r(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return t(this[n],o,arguments)})})}function o(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function i(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return e=this[n],(r=t(e,o,arguments)).then(function(e){if(e)return new s(e,r.request)});var e,r})})}function a(e){this._index=e}function s(e,t){this._cursor=e,this._request=t}function u(e){this._store=e}function c(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function l(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new c(n)}function f(e){this._db=e}n(a,"_index",["name","keyPath","multiEntry","unique"]),r(a,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),i(a,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(s,"_cursor",["direction","key","primaryKey","value"]),r(s,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(s.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new s(e,n._request)})})})}),u.prototype.createIndex=function(){return new a(this._store.createIndex.apply(this._store,arguments))},u.prototype.index=function(){return new a(this._store.index.apply(this._store,arguments))},n(u,"_store",["name","keyPath","indexNames","autoIncrement"]),r(u,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),i(u,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(u,"_store",IDBObjectStore,["deleteIndex"]),c.prototype.objectStore=function(){return new u(this._tx.objectStore.apply(this._tx,arguments))},n(c,"_tx",["objectStoreNames","mode"]),o(c,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new u(this._db.createObjectStore.apply(this._db,arguments))},n(l,"_db",["name","version","objectStoreNames"]),o(l,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new c(this._db.transaction.apply(this._db,arguments))},n(f,"_db",["name","version","objectStoreNames"]),o(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[u,a].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],o=this._store||this._index,i=o[e].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}}})}),[a,u].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():o(r)):o(r)})})})});var d={open:function(e,n,r){var o=t(indexedDB,"open",[e,n]),i=o.request;return i.onupgradeneeded=function(e){r&&r(new l(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new f(e)})},delete:function(e){return t(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?(module.exports=d,module.exports.default=module.exports):self.idb=d}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var map,google,DBHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"dbPromise",set:function(e){this._dbPromise=e},get:function(){return this._dbPromise}},{key:"dbOpened",set:function(e){this._dbOpened=e},get:function(){return this._dbOpened}}],[{key:"fetchRestaurants",value:function(t){e.openDB().then(function(n){n?(e.dbPromise=n,e.getRestaurantsFromDB().then(function(n){n.length?t(null,n):e.fetchRestaurantsFromNetwork(t)})):e.fetchRestaurantsFromNetwork(t)}).then(function(){}).catch(function(){e.fetchRestaurantsFromNetwork(t)})}},{key:"fetchRestaurantsFromNetwork",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=new XMLHttpRequest;r.open("GET",e.DATABASE_URL),r.onload=function(){if(200===r.status){var o=JSON.parse(r.responseText);t(null,o),n&&e.saveRestaurantsToDB(o)}else{var i="Request failed. Returned status of "+r.status;t(i,null)}},r.send()}},{key:"fetchRestaurantById",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.find(function(e){return e.id==t});o?n(null,o):n("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.filter(function(e){return e.cuisine_type==t});n(null,o)}})}},{key:"fetchRestaurantByNeighborhood",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.filter(function(e){return e.neighborhood==t});n(null,o)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(t,n,r){e.fetchRestaurants(function(e,o){if(e)r(e,null);else{var i=o;"all"!=t&&(i=i.filter(function(e){return e.cuisine_type==t})),"all"!=n&&(i=i.filter(function(e){return e.neighborhood==n})),r(null,i)}})}},{key:"fetchNeighborhoods",value:function(t){e.fetchRestaurants(function(e,n){if(e)t(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),o=r.filter(function(e,t){return r.indexOf(e)==t});t(null,o)}})}},{key:"fetchCuisines",value:function(t){e.fetchRestaurants(function(e,n){if(e)t(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),o=r.filter(function(e,t){return r.indexOf(e)==t});t(null,o)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.id}},{key:"imageDescriptionForRestaurant",value:function(e){return["Inside view of the Mission Chinese Food restaurant. Many people talk to each other","A pizza cut into six slices","Inside view of Kang Ho Dong Baekjeong restaurant. You can see various modern style tables and chairs","Panoramic photo of the entrance. You can see the two streets on which the restaurant overlooks","Inside view of the Roberto's Pizza. In the background, see the kitchen and some pizza makers","Inside view of the Hometown BBQ restaurant. On the wall a huge US flag","Two people walking around the restaurand. You can see some customers inside","Detail of the The Dutch banner","Inside view of the Mu Ramen restaurant. Some customers eat using the typical oriental chopsticks","Inside view of restaurant. You see the counter with the window and several bottles."][e.id-1]}},{key:"mapMarkerForRestaurant",value:function(t,n){return new google.maps.Marker({position:t.latlng,title:t.name,url:e.urlForRestaurant(t),map:n,animation:google.maps.Animation.DROP})}},{key:"openDB",value:function(){return e.dbOpened=!0,"indexedDB"in window?idb.open("restaurants-reviews",4,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("reviews",{keyPath:"id"}),e.transaction.objectStore("reviews").createIndex("restaurant","restaurant_id");case 2:e.createObjectStore("offline-reviews",{keyPath:"id",autoIncrement:!0});case 3:e.createObjectStore("offline-favorites",{keyPath:"id",autoIncrement:!0})}}):Promise.resolve()}},{key:"deleteRestaurantsFromDB",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.db;if(t){var n=t.transaction("restaurants","readwrite");return n.objectStore("restaurants").clear(),n.complete}}},{key:"addRestaurantToDB",value:function(e,t){if(e){var n=e.transaction("restaurants","readwrite");return n.objectStore("restaurants").put(t),n.complete}}},{key:"getRestaurantsFromDB",value:function(){if(e.dbPromise)return e.dbPromise.transaction("restaurants","readonly").objectStore("restaurants").getAll()}},{key:"saveRestaurantsToDB",value:function(t){if(e.dbOpened){if(1==navigator.onLine){e.deleteRestaurantsFromDB();var n=e.dbPromise.transaction("restaurants","readwrite"),r=n.objectStore("restaurants");return t.forEach(function(e){r.put(e)}),n.complete}return!1}}},{key:"updateRestaurantLocalDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("restaurants","readwrite");return n.objectStore("restaurants").put(t),n.complete}}},{key:"addReviewToOfflineDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("offline-reviews","readwrite");return n.objectStore("offline-reviews").put(t),n.complete}}},{key:"getReviewsOffline",value:function(){if(e.dbPromise)return e.dbPromise.transaction("offline-reviews","readonly").objectStore("offline-reviews").getAll()}},{key:"deleteReviewFromOffline",value:function(t){return e.dbPromise.transaction("offline-reviews","readwrite").objectStore("offline-reviews").delete(t.id)}},{key:"addFavoriteToOfflineDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("offline-favorites","readwrite");return n.objectStore("offline-favorites").put(t),n.complete}}},{key:"getFavoritesOffline",value:function(){if(e.dbPromise)return e.dbPromise.transaction("offline-favorites","readonly").objectStore("offline-favorites").getAll()}},{key:"deleteFavoriteFromOffline",value:function(t){return e.dbPromise.transaction("offline-favorites","readwrite").objectStore("offline-favorites").delete(t.id)}},{key:"updateFavorite",value:function(t){return fetch(e.DATABASE_URL+"/"+t.id+"/?is_favorite="+t.value,{method:"PUT"}).then(function(){e.fetchRestaurantsFromNetwork(function(e,t){},!0)}).catch(function(n){e.addFavoriteToOfflineDB(t)})}},{key:"sendOfflineFavoritesToServer",value:function(t){return e.getFavoritesOffline().then(function(t){t.forEach(function(t){return e.updateFavorite(t).then(function(){toast("Favorites offline submitted",5e3),e.deleteFavoriteFromOffline(t)}).catch(function(e){})})})}},{key:"sendOfflineReviewsToServer",value:function(){return e.getReviewsOffline().then(function(t){t.forEach(function(t){var n=new FormData;return n.append("restaurant_id",t.restaurant_id),n.append("name",t.name),n.append("rating",t.rating),n.append("comments",t.comments),fetch(e.DATABASE_REVIEWS_URL+"/",{method:"POST",body:n}).then(function(){return toast("Review offline submitted",5e3),e.deleteReviewFromOffline(t),e.fetchReviewsFromNetwork(t.restaurant_id,function(e,t){window.location.href.includes("/restaurant.html?id=")&&fillReviewsHTML(t,!1,!0)},!0)}).catch(function(e){toast("Sending review offline.... Oops! Something went wrong.",5e3)})})})}},{key:"syncFavorites",value:function(){e.sendOfflineFavoritesToServer(function(e,t){if(e)return e})}},{key:"syncReviews",value:function(t){return e.sendOfflineReviewsToServer().then(function(){return t(null)}).catch(function(e){return t(e,null)})}},{key:"syncAll",value:function(){1==navigator.onLine&&setTimeout(function(){e.syncFavorites(),e.syncReviews(function(e){if(e)return e})},2e3)}},{key:"setFavoriteStatus",value:function(e){if(e.is_favorite){var t=document.getElementById(e.id);1==e.is_favorite||"true"==e.is_favorite?t.classList.add("restaurant-name_isfavorite"):t.classList.remove("restaurant-name_isfavorite")}}},{key:"saveFavoriteToNetwork",value:function(t){return e.updateFavorite(t.id,t.is_favorite,function(e,t){})}},{key:"fetchReviews",value:function(t,n){e.openDB().then(function(r){r?(e.dbPromise=r,e.getReviewsFromDB(t).then(function(r){if(r.length)return n(null,r);e.fetchReviewsFromNetwork(t,n)})):e.fetchReviewsFromNetwork(t,n)}).then(function(){}).catch(function(){e.fetchReviewsFromNetwork(t,n)})}},{key:"fetchReviewById",value:function(t,n){e.fetchReviews(null,function(e,r){if(e)n(e,null);else{var o=r.find(function(e){return e.id==t});o?n(null,o):n("Review does not exist",null)}})}},{key:"fetchReviewsFromNetwork",value:function(t,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return fetch(e.DATABASE_REVIEWS_URL+"/?restaurant_id="+t,{method:"GET"}).then(function(e){return e.json()}).then(function(o){var i=o;return r?e.saveReviewsToDB(t,i).then(function(){return n(null,i)}):n(null,i)}).catch(function(e){return n(e,null)})}},{key:"saveReviewsToDB",value:function(t,n){if(e.dbOpened)return 1==navigator.onLine&&e.deleteReviewsFromDB(t).then(function(){var t=e.dbPromise.transaction("reviews","readwrite"),r=t.objectStore("reviews");return n.forEach(function(e){e.restaurant_id=parseInt(e.restaurant_id),r.put(e)}),t.complete})}},{key:"deleteReviewsFromDB",value:function(t){if(e.dbPromise)return e.getReviewsFromDB(t).then(function(t){var n=e.dbPromise.transaction("reviews","readwrite"),r=n.objectStore("reviews");return t.forEach(function(e){r.delete(e.id)}),n.complete})}},{key:"getReviewsFromDB",value:function(t){if(e.dbPromise){var n=e.dbPromise.transaction("reviews","readonly").objectStore("reviews");return t?n.index("restaurant").getAll(Number(t)):n.getAll()}}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}},{key:"DATABASE_REVIEWS_URL",get:function(){return"http://localhost:1337/reviews"}}]),e}(),restaurants=void 0,neighborhoods=void 0,cuisines=void 0,markers=[],showImage=function(e,t){e.forEach(function(e){e.isIntersecting&&(loadPicture(e.target),t.unobserve(e.target))})},options={root:null,rootMargin:"0px",threshold:[0]},observer=new IntersectionObserver(showImage,options);function loadPicture(e){var t=e.getElementsByTagName("source")[0],n=e.getElementsByTagName("source")[1],r=e.getElementsByTagName("img")[0],o=t.dataset.src,i=n.dataset.src,a=r.dataset.src;a&&(t.srcset=o,n.srcset=i,r.src=a)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(e){},function(e){})}),document.addEventListener("DOMContentLoaded",function(e){fetchNeighborhoods(),fetchCuisines()});var fetchNeighborhoods=function(){DBHelper.fetchNeighborhoods(function(e,t){e||(self.neighborhoods=t,fillNeighborhoodsHTML())})},fillNeighborhoodsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.neighborhoods,t=document.getElementById("neighborhoods-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},fetchCuisines=function(){DBHelper.fetchCuisines(function(e,t){e||(self.cuisines=t,fillCuisinesHTML())})},fillCuisinesHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.cuisines,t=document.getElementById("cuisines-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},updateRestaurants=function(){var e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),n=e.selectedIndex,r=t.selectedIndex,o=e[n].value,i=t[r].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(o,i,function(e,t){e||(resetRestaurants(t),fillRestaurantsHTML())})},resetRestaurants=function(e){self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.restaurants=e,document.getElementById("map").classList.contains("inactive")||(self.markers.forEach(function(e){return e.setMap(null)}),self.markers=[])},fillRestaurantsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants,t=document.getElementById("restaurants-list");e.forEach(function(e){t.append(createRestaurantHTML(e))}),document.getElementById("image-blurred-text").hidden&&addMarkersToMap()},createRestaurantHTML=function(e){var t=document.createElement("li"),n=document.createElement("picture"),r=document.createElement("source");r.setAttribute("type","image/webp"),n.append(r);var o=document.createElement("source");o.setAttribute("type","image/jpeg"),n.append(o);var i=document.createElement("img");i.className="restaurant-img",i.alt=DBHelper.imageDescriptionForRestaurant(e),"IntersectionObserver"in window?(r.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".webp"),o.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".jpg"),i.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".jpg")):(r.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e)+".webp"),o.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e)+".jpg"),i.src=DBHelper.imageUrlForRestaurant(e)+".jpg"),n.append(i),t.append(n),observer.observe(n);var a=document.createElement("h1");a.innerHTML=e.name,t.append(a);var s=document.createElement("p");s.innerHTML=e.neighborhood,t.append(s);var u=document.createElement("p");u.innerHTML=e.address,t.append(u);var c=document.createElement("button");return c.classList.add("button"),c.innerHTML="View Details",c.addEventListener("click",function(){window.location.href=DBHelper.urlForRestaurant(e)}),t.append(c),DBHelper.getFavoritesOffline().then(function(n){if(n.length){var r=n.filter(function(t){return t.id==e.id});r.length&&(e.is_favorite=r[0].value)}var o=document.createElement("button");o.classList.add("mdc-fab","mdc-fab--mini","app-fab--favorite");var i=document.createElement("span");i.classList.add("mdc-fab__icon","material-icons"),i.innerText="favorite",o.append(i),t.append(o),e.is_favorite&&(1==e.is_favorite||"true"==e.is_favorite?(o.classList.add("app-fab--isfavorite"),o.setAttribute("aria-label","The restaurant is marked as favorite")):o.setAttribute("aria-label","Click to mark the restaurant as favorite")),o.id=e.id,o.addEventListener("click",onFavoriteClick)}),t},addMarkersToMap=function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants).forEach(function(e){var t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",function(){window.location.href=t.url}),self.markers.push(t)})};function gm_authFailure(){}function showMap(){var e=document.getElementById("GoogleMaps");e.src=e.dataset.src}function onFavoriteClick(e){var t=e.target.parentElement,n={id:t.id,value:"false"};t.classList.contains("app-fab--isfavorite")||(n.value="true"),DBHelper.updateFavorite(n).then(function(){}),"true"==n.value?t.setAttribute("aria-label","The restaurant is marked as favorite"):t.setAttribute("aria-label","Click to mark the restaurant as favorite"),t.classList.toggle("app-fab--isfavorite")}function toast(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=document.getElementById("toast"),o=void 0;if(1==r.classList.contains("show")){if(e==r.innerText)return;if(0==n)return void setTimeout(function(){clearTimeout(o),toast(e,t,n)},2e3)}r.innerText=e,r.classList.add("show"),o=setTimeout(function(){r.classList.remove("show")},t)}window.initMap=function(){self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},gestureHandling:"cooperative"}),updateRestaurants(),document.getElementById("map").classList.remove("inactive"),document.getElementById("image-blurred").hidden=!0,document.getElementById("image-blurred-text").hidden=!0},window.googleMapsError=function(){},window.addEventListener("load",function(e){updateRestaurants(),document.getElementById("map-container").addEventListener("click",showMap),DBHelper.syncAll()}),window.addEventListener("online",function(e){document.getElementById("offline").classList.remove("show"),toast("You are online.\nAll changes will be synchronized.",3e3),DBHelper.syncAll()}),window.addEventListener("offline",function(e){document.getElementById("offline").classList.add("show"),toast("You are offine.\nAll changes will be synchronized when you return online.",5e3)}),window.addEventListener("DOMContentLoaded",function(e){navigator.onLine||document.getElementById("offline").classList.add("show")});
//# sourceMappingURL=main_all.js.map
