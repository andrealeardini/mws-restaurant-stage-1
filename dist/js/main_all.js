"use strict";!function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function t(t,n,r){var o,a=new Promise(function(a,s){e(o=t[n].apply(t,r)).then(a,s)});return a.request=o,a}function n(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function r(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return t(this[n],o,arguments)})})}function o(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function a(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return e=this[n],(r=t(e,o,arguments)).then(function(e){if(e)return new i(e,r.request)});var e,r})})}function s(e){this._index=e}function i(e,t){this._cursor=e,this._request=t}function u(e){this._store=e}function c(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function l(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new c(n)}function d(e){this._db=e}n(s,"_index",["name","keyPath","multiEntry","unique"]),r(s,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),a(s,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(i,"_cursor",["direction","key","primaryKey","value"]),r(i,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(i.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new i(e,n._request)})})})}),u.prototype.createIndex=function(){return new s(this._store.createIndex.apply(this._store,arguments))},u.prototype.index=function(){return new s(this._store.index.apply(this._store,arguments))},n(u,"_store",["name","keyPath","indexNames","autoIncrement"]),r(u,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),a(u,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(u,"_store",IDBObjectStore,["deleteIndex"]),c.prototype.objectStore=function(){return new u(this._tx.objectStore.apply(this._tx,arguments))},n(c,"_tx",["objectStoreNames","mode"]),o(c,"_tx",IDBTransaction,["abort"]),l.prototype.createObjectStore=function(){return new u(this._db.createObjectStore.apply(this._db,arguments))},n(l,"_db",["name","version","objectStoreNames"]),o(l,"_db",IDBDatabase,["deleteObjectStore","close"]),d.prototype.transaction=function(){return new c(this._db.transaction.apply(this._db,arguments))},n(d,"_db",["name","version","objectStoreNames"]),o(d,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[u,s].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],o=this._store||this._index,a=o[e].apply(o,n.slice(0,-1));a.onsuccess=function(){r(a.result)}}})}),[s,u].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():o(r)):o(r)})})})});var f={open:function(e,n,r){var o=t(indexedDB,"open",[e,n]),a=o.request;return a.onupgradeneeded=function(e){r&&r(new l(a.result,e.oldVersion,a.transaction))},o.then(function(e){return new d(e)})},delete:function(e){return t(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?(module.exports=f,module.exports.default=module.exports):self.idb=f}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var map,google,DBHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"dbPromise",set:function(e){this._dbPromise=e},get:function(){return this._dbPromise}},{key:"dbOpened",set:function(e){this._dbOpened=e},get:function(){return this._dbOpened}}],[{key:"fetchRestaurants",value:function(t){return e.openDB().then(function(n){if(n)return e.dbPromise=n,console.log(e.dbPromise),e.getRestaurantsFromDB().then(function(n){if(n.length)return t(null,n);console.log("No restaurants in db"),e.fetchRestaurantsFromNetwork(t)});console.log("db not found"),e.fetchRestaurantsFromNetwork(t)}).then(function(){}).catch(function(){console.log("Catch the promise error"),e.fetchRestaurantsFromNetwork(t)})}},{key:"fetchRestaurantsFromNetwork",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=new XMLHttpRequest;r.open("GET",e.DATABASE_URL),r.onload=function(){if(200===r.status){var o=JSON.parse(r.responseText);console.log("Ristoranti letti dal server"),t(null,o),n&&e.saveRestaurantsToDB(o)}else{var a="Request failed. Returned status of "+r.status;t(a,null)}},r.send()}},{key:"fetchRestaurantById",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.find(function(e){return e.id==t});o?n(null,o):n("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.filter(function(e){return e.cuisine_type==t});n(null,o)}})}},{key:"fetchRestaurantByNeighborhood",value:function(t,n){e.fetchRestaurants(function(e,r){if(e)n(e,null);else{var o=r.filter(function(e){return e.neighborhood==t});n(null,o)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(t,n,r){e.fetchRestaurants(function(e,o){if(e)r(e,null);else{var a=o;"all"!=t&&(a=a.filter(function(e){return e.cuisine_type==t})),"all"!=n&&(a=a.filter(function(e){return e.neighborhood==n})),r(null,a)}})}},{key:"fetchNeighborhoods",value:function(t){e.fetchRestaurants(function(e,n){if(e)t(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),o=r.filter(function(e,t){return r.indexOf(e)==t});t(null,o)}})}},{key:"fetchCuisines",value:function(t){e.fetchRestaurants(function(e,n){if(e)t(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),o=r.filter(function(e,t){return r.indexOf(e)==t});t(null,o)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.id}},{key:"imageDescriptionForRestaurant",value:function(e){return["Inside view of the Mission Chinese Food restaurant. Many people talk to each other","A pizza cut into six slices","Inside view of Kang Ho Dong Baekjeong restaurant. You can see various modern style tables and chairs","Panoramic photo of the entrance. You can see the two streets on which the restaurant overlooks","Inside view of the Roberto's Pizza. In the background, see the kitchen and some pizza makers","Inside view of the Hometown BBQ restaurant. On the wall a huge US flag","Two people walking around the restaurand. You can see some customers inside","Detail of the The Dutch banner","Inside view of the Mu Ramen restaurant. Some customers eat using the typical oriental chopsticks","Inside view of restaurant. You see the counter with the window and several bottles."][e.id-1]}},{key:"mapMarkerForRestaurant",value:function(t,n){return new google.maps.Marker({position:t.latlng,title:t.name,url:e.urlForRestaurant(t),map:n,animation:google.maps.Animation.DROP})}},{key:"openDB",value:function(){return e.dbOpened=!0,"indexedDB"in window?idb.open("restaurants-reviews",2,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("offline-restaurants",{keyPath:"id"})}}):(console.log("This browser doesn't support IndexedDB"),Promise.resolve())}},{key:"addRestaurantToDB",value:function(e,t){if(e){console.log("Adding record");var n=e.transaction("restaurants","readwrite");return n.objectStore("restaurants").put(t),console.log("Record added"),n.complete}}},{key:"getRestaurantsFromDB",value:function(){if(e.dbPromise)return e.dbPromise.transaction("restaurants","readonly").objectStore("restaurants").getAll()}},{key:"saveRestaurantsToDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("restaurants","readwrite"),r=n.objectStore("restaurants");return t.forEach(function(e){r.put(e)}),console.log("Local DB Updated from Network"),n.complete}}},{key:"updateRestaurantLocalDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("restaurants","readwrite");return n.objectStore("restaurants").put(t),n.complete}}},{key:"addRestaurantToOfflineDB",value:function(t){if(e.dbOpened){var n=e.dbPromise.transaction("offline-restaurants","readwrite");return n.objectStore("offline-restaurants").put(t),n.complete}}},{key:"updateFavorite",value:function(t,n,r){return fetch("http://localhost:1337/restaurants/"+t+"/?is_favorite="+n,{method:"PUT"}).then(function(){return console.log("Send PUT with favorite="+n),e.fetchRestaurantById(t,function(t,o){return self.restaurant=o,o||(console.error(t),r(t,null)),o.is_favorite=n,e.updateRestaurantLocalDB(o).then(function(){r(null,!0)})})}).catch(function(o){return console.log("Error when try to fetch data on server... ",o),e.fetchRestaurantById(t,function(t,o){return self.restaurant=o,o||(console.error(t),r(t,null)),o.is_favorite=n,o.updatedAt=new Date,e.updateRestaurantLocalDB(o).then(function(){console.log("Restaurant saved on the local DB"),r(null,!0)})})})}},{key:"deleteRestaurantFromOffline",value:function(t){return e.dbPromise.transaction("offline-restaurants","readwrite").objectStore("offline-restaurants").delete(t.id)}},{key:"syncRestaurants",value:function(){var t=[],n=[];return e.openDB().then(function(r){r&&(e.dbPromise=r,console.log(e.dbPromise),e.getRestaurantsFromDB().then(function(e){if(!e.length)return"No restaurants in local DB";n=e}).then(function(){return console.log("Restaurant from local DB: ",n),e.fetchRestaurantsFromNetwork(function(n,r){if(n)return n;r.length&&(t=r,console.log("Restaurant from server: ",t),t.forEach(function(t){return e.fetchRestaurantById(t.id,function(n,r){if(n)return n;var o=new Date(t.updatedAt),a=new Date(r.updatedAt);o>a&&e.updateRestaurantLocalDB(t),o<a&&e.saveFavoriteToNetwork(r)})}))},!1)}).catch(function(e){console.log("Error in sync")}))})}},{key:"saveFavoriteToNetwork",value:function(t){return e.updateFavorite(t.id,t.is_favorite,function(e,t){t&&console.log("Favorite Updated from LocalDB")})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}}]),e}(),restaurants=void 0,neighborhoods=void 0,cuisines=void 0,markers=[],showImage=function(e,t){e.forEach(function(e){e.isIntersecting&&(loadPicture(e.target),t.unobserve(e.target))})},options={root:null,rootMargin:"0px",threshold:[0]},observer=new IntersectionObserver(showImage,options);function loadPicture(e){var t=e.getElementsByTagName("source")[0],n=e.getElementsByTagName("source")[1],r=e.getElementsByTagName("img")[0],o=t.dataset.src,a=n.dataset.src,s=r.dataset.src;s&&(t.srcset=o,n.srcset=a,r.src=s)}"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)},function(e){console.log("ServiceWorker registration failed: ",e)})}),document.addEventListener("DOMContentLoaded",function(e){fetchNeighborhoods(),fetchCuisines()});var fetchNeighborhoods=function(){DBHelper.fetchNeighborhoods(function(e,t){e?console.error(e):(self.neighborhoods=t,fillNeighborhoodsHTML())})},fillNeighborhoodsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.neighborhoods,t=document.getElementById("neighborhoods-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},fetchCuisines=function(){DBHelper.fetchCuisines(function(e,t){e?console.error(e):(self.cuisines=t,fillCuisinesHTML())})},fillCuisinesHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.cuisines,t=document.getElementById("cuisines-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},updateRestaurants=function(){var e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),n=e.selectedIndex,r=t.selectedIndex,o=e[n].value,a=t[r].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(o,a,function(e,t){e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})},resetRestaurants=function(e){self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.restaurants=e,document.getElementById("map").classList.contains("inactive")||(self.markers.forEach(function(e){return e.setMap(null)}),self.markers=[])},fillRestaurantsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants,t=document.getElementById("restaurants-list");e.forEach(function(e){t.append(createRestaurantHTML(e))}),document.getElementById("image-blurred-text").hidden&&addMarkersToMap()},createRestaurantHTML=function(e){var t=document.createElement("li"),n=document.createElement("picture"),r=document.createElement("source");r.setAttribute("type","image/webp"),n.append(r);var o=document.createElement("source");o.setAttribute("type","image/jpeg"),n.append(o);var a=document.createElement("img");a.className="restaurant-img",a.alt=DBHelper.imageDescriptionForRestaurant(e),"IntersectionObserver"in window?(r.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".webp"),o.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".jpg"),a.setAttribute("data-src",DBHelper.imageUrlForRestaurant(e)+".jpg")):(r.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e)+".webp"),o.setAttribute("srcset",DBHelper.imageUrlForRestaurant(e)+".jpg"),a.src=DBHelper.imageUrlForRestaurant(e)+".jpg"),n.append(a),t.append(n),observer.observe(n);var s=document.createElement("h1");s.innerHTML=e.name+" ";var i=document.createElement("i");i.innerHTML="favorite",i.classList.add("material-icons"),i.classList.add("restaurant-name_favorite"),e.is_favorite&&(1!=e.is_favorite&&"true"!=e.is_favorite||i.classList.add("restaurant-name_isfavorite")),i.id=e.id,s.append(i),t.append(s),i.addEventListener("click",onFavoriteClick);var u=document.createElement("p");u.innerHTML=e.neighborhood,t.append(u);var c=document.createElement("p");c.innerHTML=e.address,t.append(c);var l=document.createElement("button");return l.innerHTML="View Details",l.addEventListener("click",function(){window.location.href=DBHelper.urlForRestaurant(e)}),t.append(l),t},addMarkersToMap=function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants).forEach(function(e){var t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",function(){window.location.href=t.url}),self.markers.push(t)})};function gm_authFailure(){console.log("Google Maps Error to handle")}function showMap(){var e=document.getElementById("GoogleMaps");e.src=e.dataset.src}function onFavoriteClick(e){var t=e.target;console.log("Click on favorite: ",t.id);var n="false";t.classList.contains("restaurant-name_isfavorite")||(n="true"),DBHelper.updateFavorite(t.id,n,function(e,n){n&&t.classList.toggle("restaurant-name_isfavorite")})}window.initMap=function(){self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},gestureHandling:"cooperative"}),updateRestaurants(),document.getElementById("map").classList.remove("inactive"),document.getElementById("image-blurred").classList.remove("blur"),document.getElementById("image-blurred-text").hidden=!0},window.googleMapsError=function(){console.log("Google Maps Error to handle")},window.addEventListener("load",function(e){DBHelper.syncRestaurants(),updateRestaurants(),document.getElementById("map-container").addEventListener("click",showMap)}),window.addEventListener("online",function(e){console.log("You are online"),DBHelper.syncRestaurants()}),window.addEventListener("offline",function(e){console.log("You are offline"),alert("You are offine. All the changes will be synchronized when you return online.")});
//# sourceMappingURL=main_all.js.map
